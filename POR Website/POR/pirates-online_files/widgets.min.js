define("widgets/utils/wixCodeRemoteModelService",["lodash","RemoteModelInterface","utils"],function(a,b,c){"use strict";var d=function(d,e,f,g,h){var i=new b(void 0,g);return a.forEach(e,function(a){i.addComponent(a,c.widgetModel.getCompModel(d,a))},this),i.addPagesData(f),i.addConnections(c.widgetModel.getConnectionsModel(d,e,h)),i},e=function(a,c){return new b(a,c)};return{generateRemoteModelInterface:d,createRemoteModelInterface:e}}),define("widgets/core/widgetDataHelper",["lodash"],function(a){"use strict";return{registerWidgetHandler:function(b,c){a.set(b,"widgetHandler",c)},getWidgetHandler:function(b){return a.get(b,"widgetHandler")},getWidgetsOfRoots:function(b,c){var d=a.get(b,["widgetInstances"],[]);return a.filter(d,function(b){return a.includes(c,b.rootId)})}}}),define("widgets/core/dataResolvers/pageLinkDataResolver",["lodash"],function(a){"use strict";function b(b,c){if("#"===b)return c.getPrimaryPageId();var d=c.findDataOnMasterPageByPredicate(function(a){return a.pageUriSEO===b.replace("#","")});return a.get(d,"id",b)}function c(b){var c=a.get(b,"link");return c?[c]:a.get(b,"linkList")}function d(d,e){var f=e.getSiteData();return a.forEach(c(d),function(c){var d=c.type;if("PageLink"===d||"AnchorLink"===d){var e=c.pageId;a.isString(e)&&(c.pageId=b(e,f));var g=c.anchorDataId;if(a.isString(g)){e=a.isString(c.pageId)?c.pageId:c.pageId.id;var h=f.pagesData[e].structure.components,i=a.find(h,{nickname:g});c.anchorDataId=i.dataQuery}}}),d}return{resolve:d}}),define("widgets/core/dataResolvers/widgetDataResolvers",["lodash","widgets/core/dataResolvers/pageLinkDataResolver"],function(a,b){"use strict";var c=[b];return{resolve:function(b,d){return a.forEach(c,function(a){b=a.resolve(b,d)}),b}}}),define("widgets/core/modelBuilderDataHelper",["lodash"],function(a){"use strict";function c(a){return{fetchData:a.getDataByQuery.bind(a),fetchPagesData:a.getPagesDataForRmi.bind(a)}}function d(c){return"Page"===a.get(c,"type")?a.get(c,"isPopup")?b.POPUP:b.PAGE:void 0}var b={PAGE:"Page",POPUP:"Popup"};return{getApi:c,getWidgetType:d,WIDGET_TYPES:b}}),define("widgets/core/modelBuilder",["lodash","utils","widgets/utils/wixCodeRemoteModelService","widgets/core/modelBuilderDataHelper"],function(a,b,c,d){"use strict";function f(b,d,e,f){return a.mapValues(d,function(a,d){return c.generateRemoteModelInterface(b,a,f(),e,d)},this)}function g(b,c){var d=[e.PAGES_CONTAINER_ID,e.SITE_PAGES_ID],f=c(b,b);return a(f).omit([e.SITE_STRUCTURE_ID]).keys().difference(d).value()}function h(a,b){var c=b(a,a),e=d.getWidgetType(c);return e===d.WIDGET_TYPES.PAGE}function i(c,d,e){var f=b.siteConstants.MASTER_PAGE_ID,i=g(f,d),j=a.without(c,f);return a.transform(j,function(a,b){a[b]=g(b,d),h(b,e)&&(a[b]=a[b].concat(i))},{})}function j(a,b,c,e,g){var h=d.getApi(b),j=i(c,g,h.fetchData);return f(a,j,e,h.fetchPagesData)}var e=b.siteConstants;return{build:j}}),define("widgets/messages/messageBuilder",[],function(){"use strict";function a(a){return{type:"load_widgets",widgets:a}}function b(a){return{type:"init_widgets",controllers:a}}function c(a){return{type:"start_widgets",contexts:a}}function d(a){return{type:"stop_widgets",widgetIds:a}}function e(a,b){return{type:"update",contextId:a,updates:b}}return{loadWidgetsMessage:a,initWidgetsMessage:b,startWidgetsMessage:c,stopWidgetsMessage:d,updateWidgetMessage:e}}),define("widgets/core/RemoteWidgetHandlerProxy",["lodash","core","widgets/core/dataResolvers/widgetDataResolvers","widgets/core/modelBuilder","widgets/messages/messageBuilder"],function(a,b,c,d,e){"use strict";function h(){for(;!a.isEmpty(this._messageQueue);){var b=this._messageQueue.shift();this._postMessageDelegate(b)}this.hasQueuedMessages=!1}function i(a){this._postMessageDelegate?this.hasQueuedMessages?(this._messageQueue.push(a),h.call(this)):this._postMessageDelegate(a):(this.hasQueuedMessages=!0,this._messageQueue.push(a))}function j(b,c,d,e){var f={data:"setCompData",props:"setCompProps",events:"addActionsAndBehaviors",layout:"updateCompLayout"};this._runtimeDal[f[c]](b,d),a.isFunction(this._onUpdateCallback)&&this._onUpdateCallback(e)}function k(a){var b=this._siteAPI.getSiteDataAPI().document,c=b.getAllCompsUnderRoot.bind(b);return d.build(this._siteAPI.getRuntimeDal(),this._siteAPI.getSiteData(),a,j.bind(this),c)}function l(a,b){this._runtimeDal=a.getRuntimeDal(),this._siteAPI=a,this._postMessageDelegate=null,this._remoteModelInterfaces={},this._messageQueue=[],this._onUpdateCallback=b,this._updatingWidget=!1,this._readyWidgets={}}function m(a){return this._remoteModelInterfaces[a]}function n(b,d,e,f){var g=b.getSiteData(),h=a.assign({},d.getCompData(e),f);return h=c.resolve(h,b),g.resolveData(h,g.getPrimaryPageId(),g.dataTypes.DATA)}var f={State:"stateChanged",Data:"dataChanged",Props:"propsChanged",Event:"registerEvent",Layout:"layoutChanged",Behavior:"executeBehavior"},g={WidgetReady:"widget_ready"};return l.prototype.registerPostMessageDelegate=function(a){this._postMessageDelegate=a,h.call(this)},l.prototype.initWidgets=function(a,b){var c={};c[a]=b;var d=e.initWidgetsMessage(c);this._sendOrQueueMessage(d)},l.prototype.startWidgets=function(b){if(!a.isEmpty(b)){a.assign(this._remoteModelInterfaces,k.call(this,b)),a.forEach(b,function(a){this._readyWidgets[a]=!1},this);var c=a.mapValues(this._remoteModelInterfaces,function(a){return a.toJson()}),d=e.startWidgetsMessage(c);this._sendOrQueueMessage(d)}},l.prototype.loadWidgets=function(b){var c=e.loadWidgetsMessage(b);this._sendOrQueueMessage(c),a.forEach(b,function(a){this._readyWidgets[a.id]=!1,delete this._remoteModelInterfaces[a.id]},this)},l.prototype.getActiveWidgetIds=function(){return a.keys(this._remoteModelInterfaces)},l.prototype.stopWidgets=function(b){if(!a.isEmpty(b)){a.forEach(b,function(a){delete this._remoteModelInterfaces[a],this._readyWidgets[a]=!1},this);var c=e.stopWidgetsMessage(b);this._sendOrQueueMessage(c)}},l.prototype.stopAllWidgets=function(){this.stopWidgets(a.keys(this._remoteModelInterfaces))},l.prototype.updateComponent=function(a){this._sendOrQueueMessage(a)},l.prototype.handleWidgetUpdate=function(b){var c=a(b).keys().first(),d=a.pick(this._remoteModelInterfaces,function(b){return a.has(b.toJson(),["components",c])});if(!a.isEmpty(d)&&!this._updatingWidget){var f=a(d).keys().first();d[f].updateModel(b);var g=e.updateWidgetMessage(f,b);this._sendOrQueueMessage(g)}},l.prototype.handleRemoteMessage=function(a){switch(a.type){case g.WidgetReady:m.call(this,a.widgetId)&&(this._readyWidgets[a.widgetId]=!0,this._onUpdateCallback())}},l.prototype.onCommand=function(a,c){this._updatingWidget=!0;var d=this._remoteModelInterfaces[a.widgetInstanceId];if(d){switch(a.command){case f.State:d.setState(a.compId,a.data);break;case f.Data:a.data=n(this._siteAPI,this._runtimeDal,a.compId,a.data),d.setData(a.compId,a.data);break;case f.Layout:d.setLayout(a.compId,a.data);break;case f.Props:d.setProps(a.compId,a.data,c);break;case f.Event:d.registerEvent(a.widgetInstanceId,a.compId,a.data.action.name,a.data.behavior.params.callbackId);break;case f.Behavior:var e=a.data;b.behaviorsService.handleBehavior(this._siteAPI,e,c),this._onUpdateCallback&&this._onUpdateCallback(c)}this._updatingWidget=!1}},l.prototype.handleEvent=function(a,b,c,d){var e;switch(b){case"runCode":e={intent:"WIX_CODE",type:"wix_code_run_user_function",widgetInstanceId:a,callbackId:c.callbackId,compId:c.compId,event:d}}this._sendOrQueueMessage(e)},l.prototype.isWidgetReady=function(a){return!!this._readyWidgets[a]},l.prototype._sendOrQueueMessage=i,l}),define("widgets/utils/appsUtils",["lodash"],function(a){"use strict";function b(b,c,d){b=a.without(b,"masterPage");var e={displayName:"siteextension"},f=a.reject(d,e);return a.find(d,e)&&a.forEach(b,function(b){var d=c.getDataByQuery(b);f.push({id:b,type:a.get(d,"isPopup")?"Popup":"Page",displayName:d.title})}),f}function c(c,d,e){var f=a(c).filter(function(a){return"siteextension"===a.type||a.platformApp}).map(function(b){var c={id:b.appDefinitionId,displayName:b.type},d=a.get(b,"platformApp.viewerUrl");return d&&(c.url=d),c}).value();return a.find(c,{type:"siteextension"})&&f.push({type:"Application",id:"dataBinding",url:"http://static.parastorage.com/services/dbsm-viewer-app/1.3.0/app.js",displayName:"Data Binding"}),b(d,e,f)}return{getApplications:c}}),define("widgets/core/widgetService",["lodash","utils","widgets/core/widgetDataHelper","widgets/core/RemoteWidgetHandlerProxy","coreUtils","widgets/utils/appsUtils"],function(a,b,c,d,e,f){"use strict";function g(a){return!!a.renderFlags.initWixCode}function h(a,b){var c=new d(a,b);t(a,c)}function i(b,c,d){var e={dataChange:"data",propsChange:"props",stateChange:"state",layoutChange:"layout"},f=a.zipObject([e[d.type]],[d.value]),g=a.zipObject([c],[f]);u(b).handleWidgetUpdate(g)}function j(c,d,e){if(a.includes(c.getAllRenderedRootIds(),d)){var f=c.getRuntimeDal(),g=c.getSiteDataAPI(),h=g.document.getAllCompsUnderRoot(d,e),i=a(h).omit(["masterPage"]).mapValues(function(a){return b.widgetModel.getCompModel(f,a.id)}).value();u(c).handleWidgetUpdate(i)}}function k(c,d,e){var g=c.getSiteData();e=a(e).without(b.siteConstants.MASTER_PAGE_ID).difference(d).value();var h=f.getApplications(g.getClientSpecMap(),e,g);if(a.isEmpty(e)||a.isEmpty(h))return d;var i=u(c);return i.loadWidgets(h),v(c,e),i.startWidgets(e),d.concat(e)}function l(b,c,d,e){var f=u(b),g=e(c,function(b){return a.includes(d,b)});return a.isEmpty(g)?c:(f.stopWidgets(g),a.difference(c,g))}function m(b,c){var d=b.getRootIdsWhichShouldBeRendered();if(g(b.getSiteData())){var e=l(b,c,d,a.reject);return k(b,e,d)}return l(b,c,d,a.filter)}function n(a,b){var c,d=a.getRootIdsWhichShouldBeRendered();g(a.getSiteData())&&(c=k(a,b,d));var e=a.getSiteAspect("wixCodePostMessageAspect"),f=u(a);return f.registerPostMessageDelegate(e.sendPostMessage.bind(e)),c}function o(c,d){var e=d.getPageData(c);if(a.get(d.getDataByQuery(c),"isPopup"))return[{id:c,json:e}];var f=b.siteConstants.MASTER_PAGE_ID;return[{id:c,json:e},{id:f,json:d.getPageData(f)}]}function p(b,c){return a(b).transform(function(b,c){a.assign(b,a.get(c,"data.connections_data"))},{}).values().map(function(b){var d=c.resolveData(b,null,c.dataTypes.CONNECTIONS);return a.get(d,"items")}).flatten().groupBy("controllerId").value()}function q(a){return"platform.components.AppController"===a.componentType}function r(b,c){var d=p(a.map(b,"json"),c);return a(b).map(function(b){return{rootId:b.id,controllers:e.dataUtils.getAllCompsInStructure(a.get(b,"json.structure"),!1,q)}}).map(function(b){return a.map(b.controllers,function(e,f){return a.merge({controllerData:c.getDataByQuery(e.dataQuery,b.rootId),controllerId:f},{connections:a.get(d,f)})})}).flatten().value()}function s(b){return a(b).groupBy(function(b){return a.get(b,"controllerData.applicationId")}).mapValues(function(b){return a(b).groupBy("controllerId").mapValues(function(b){return a.pick(a.first(b),["controllerData","connections"])}).value()}).value()}function t(a,b){var d=a.getSiteData().widgetsStore;c.registerWidgetHandler(d,b)}function u(a){var b=a.getSiteData().widgetsStore;return c.getWidgetHandler(b)}function v(c,d){var e=c.getSiteData(),f=a(d).without(b.siteConstants.MASTER_PAGE_ID).first(),g=o(f,e),h=r(g,e);if(!a.isEmpty(h)){var i=s(h),j=u(c);j.initWidgets(f,i)}}return{getWidgetHandler:u,registerWidgetHandler:t,syncWidgetsState:m,mountWidgets:n,handleRuntimeDalCompChange:i,handleDisplayedJsonUpdate:j,createAndRegisterWidgetHandler:h,initApps:v}}),define("widgets/core/WidgetAspect",["lodash","utils","widgets/core/widgetDataHelper","widgets/core/widgetService","widgets/core/modelBuilderDataHelper","experiment"],function(a,b,c,d,e,f){"use strict";function g(b){this._siteAPI=b,this._activeWidgetIds=[],d.createAndRegisterWidgetHandler(b,this.updateSite),f.isOpen("sv_platform1")&&(this._siteAPI.registerToSiteWillMount(h.bind(this)),this._siteAPI.registerToSiteWillUpdate(i.bind(this))),this._siteAPI.getRuntimeDal().registerChangeListener(a.partial(d.handleRuntimeDalCompChange,this._siteAPI)),f.isOpen("sv_hoverBox")&&this._siteAPI.getSiteDataAPI().registerDisplayedJsonUpdateCallback(a.partial(d.handleDisplayedJsonUpdate,this._siteAPI)),this.getWidgetHandler=a.partial(d.getWidgetHandler,this._siteAPI),this.initApps=a.partial(d.initApps,this._siteAPI)}function h(){var a=d.mountWidgets(this._siteAPI,this._activeWidgetIds);a&&(this._activeWidgetIds=a)}function i(){this._activeWidgetIds=d.syncWidgetsState(this._siteAPI,this._activeWidgetIds)}function j(b,c,d){return"masterPage"!==b?b:a.find(c,function(a){var b=d.getDataByQuery(a);return e.getWidgetType(b)===e.WIDGET_TYPES.PAGE})||b}return g.prototype.updateSite=function(c){if(!this._updating){this._updating=!0;var d=this;b.animationFrame.request(function(){d._updating=!1,d._siteAPI.forceUpdate(a.isFunction(c)?c:a.noop)})}},g.prototype.isContextReady=function(b){var d=this._siteAPI.getSiteData(),e=d.widgetsStore,f=c.getWidgetHandler(e),g=j(b,this._activeWidgetIds,d);return a.isEmpty(this._activeWidgetIds)?!0:a.includes(this._activeWidgetIds,g)&&f.isWidgetReady(g)},g}),define("widgets/behaviors/widgetBehaviorHandler",["lodash"],function(a){"use strict";function c(a,b,c){var d=b.getSiteAspect("WidgetAspect"),e=d.getWidgetHandler();e.handleEvent(a.targetId,a.name,a.params,c)}function d(c){var d=a.at(c,b);return d.push(c.params.callbackId),d.join(",")}var b=["type","name","targetId"];return{handle:c,getUniqueIdentifier:d}}),define("widgets",["core","widgets/utils/wixCodeRemoteModelService","widgets/core/WidgetAspect","widgets/core/widgetDataHelper","widgets/core/modelBuilder","widgets/behaviors/widgetBehaviorHandler","widgets/messages/messageBuilder","widgets/utils/appsUtils"],function(a,b,c,d,e,f,g,h){"use strict";return a.behaviorHandlersFactory.registerHandler("widget",f),a.siteAspectsRegistry.registerSiteAspect("WidgetAspect",c),{wixCodeRemoteModelService:b,widgetDataHelper:d,messageBuilder:g,appsUtils:h,modelBuilder:e}});